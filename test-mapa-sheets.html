<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Aislado - API Google Sheets a Mapa</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: sans-serif;
        }

        #map {
            height: 70vh;
            width: 100%;
            position: relative;
        }

        #console-output {
            height: 30vh;
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-error {
            color: #ff5555;
        }

        .log-warn {
            color: #ffff55;
        }

        .log-success {
            color: #55ff55;
        }

        .custom-cluster-gen {
            background-color: rgba(33, 150, 243, 0.6);
            border: 2px solid rgba(13, 71, 161, 0.8);
            color: #fff;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* NotificaciÃ³n Flotante en el Mapa */
        #map-alerts {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-box {
            background: white;
            padding: 12px 16px;
            border-left: 4px solid #F44336;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 13px;
            color: #333;
            max-width: 250px;
        }

        .alert-box.info {
            border-left-color: #2196F3;
        }

        .alert-box strong {
            display: block;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>
    <div id="map">
        <div id="map-alerts"></div>
    </div>
    <div id="console-output"><strong>Consola de DepuraciÃ³n:</strong><br></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        function log(msg, type = 'info') {
            const out = document.getElementById('console-output');
            const colorClass = type === 'error' ? 'log-error' : (type === 'warn' ? 'log-warn' : (type === 'success' ? 'log-success' : ''));
            out.innerHTML += `<span class="${colorClass}">> ${msg}</span><br>`;
            // Auto-scroll
            out.scrollTop = out.scrollHeight;
            if (type === 'error') console.error(msg);
            else if (type === 'warn') console.warn(msg);
            else console.log(msg);
        }

        function addMapAlert(title, message, type = 'info') {
            const container = document.getElementById('map-alerts');
            const alert = document.createElement('div');
            alert.className = `alert-box ${type}`;
            alert.innerHTML = `<strong>${title}</strong>${message}`;
            container.appendChild(alert);
        }

        const map = L.map('map').setView([23.6345, -102.5528], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // Crear el MarkerClusterGroup
        const clusterGroup = L.markerClusterGroup({
            maxClusterRadius: 40,
            iconCreateFunction: function (cluster) {
                const childCount = cluster.getChildCount();
                return new L.DivIcon({
                    html: `<div><span>${childCount}</span></div>`,
                    className: 'custom-cluster-gen marker-cluster',
                    iconSize: new L.Point(35, 35)
                });
            }
        });
        map.addLayer(clusterGroup);

        const API_URL = 'https://script.google.com/macros/s/AKfycbw3heMgQJWmvUW3prcamUEQn07sldIBGZTH5WVG8Pu2t-a0mwdmfSyD27jR4fj9Ws-0yg/exec';

        async function loadData() {
            try {
                log('Iniciando fetch a API...');
                const response = await fetch(API_URL);
                log('Respuesta recibida HTTP: ' + response.status);

                const result = await response.json();
                if (result.status !== 'success' || !result.data) {
                    throw new Error('Respuesta del servidor indicÃ³ fallo o data nula.');
                }
                log('JSON Parseado! PestaÃ±as detectadas: ' + Object.keys(result.data).join(', '));

                let generacionCount = 0;
                let transmisionCount = 0;
                let transmisionSinCoordsCount = 0;

                // Test GeneraciÃ³n
                if (result.data['BBDD.GEN']) {
                    const rawData = result.data['BBDD.GEN'];
                    log(`Analizando BBDD.GEN con ${rawData.length} filas.`);

                    if (rawData.length > 1) {
                        const headerMapping = rawData[0];
                        const filasDatos = rawData.slice(1);

                        filasDatos.forEach((row, i) => {
                            let obj = {};
                            for (let key in row) {
                                if (key.startsWith('Columna_') && headerMapping[key] !== undefined) {
                                    obj[headerMapping[key].toString().trim()] = row[key];
                                }
                            }

                            if (obj.Latitud && obj.Longitud) {
                                let latStr = obj.Latitud.toString().replace(/Â°/g, '').trim();
                                let lngStr = obj.Longitud.toString().replace(/Â°/g, '').trim();
                                let lat = parseFloat(latStr);
                                let lng = parseFloat(lngStr);

                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const m = L.circleMarker([lat, lng], { radius: 8, color: '#0D47A1', fillColor: '#2196F3', fillOpacity: 0.9, weight: 2 })
                                        .bindPopup(`<b>ðŸ”Œ ${obj['Nombre del proyecto'] || 'GeneraciÃ³n'}</b><br>TecnologÃ­a: ${obj['TecnologÃ­a'] || 'N/D'}<br>Capacidad: ${obj['Capacidad'] || '?'} MW<br><br><div style="text-align:center;"><a href="tablero-nuevos-proyectos.html" target="_blank" style="background-color: #2B579A; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block; font-weight: bold; font-family: sans-serif;">Ver Seguimiento</a></div>`);

                                    clusterGroup.addLayer(m);
                                    generacionCount++;
                                }
                            }
                        });
                    }
                }

                // Test TransmisiÃ³n
                if (result.data['BBDD.TRA']) {
                    const rawData = result.data['BBDD.TRA'];
                    log(`Analizando BBDD.TRA con ${rawData.length} filas.`);

                    if (rawData.length > 1) {
                        const headerMapping = rawData[0];
                        const filasDatos = rawData.slice(1);

                        filasDatos.forEach((row, i) => {
                            let obj = {};
                            for (let key in row) {
                                if (key.startsWith('Columna_') && headerMapping[key] !== undefined) {
                                    obj[headerMapping[key].toString().trim()] = row[key];
                                }
                            }

                            let hasValidCoords = false;

                            if (obj.Latitud && obj.Longitud && obj.Latitud.toString().trim() !== '' && obj.Longitud.toString().trim() !== '') {
                                let latStr = obj.Latitud.toString().replace(/Â°/g, '').trim();
                                let lngStr = obj.Longitud.toString().replace(/Â°/g, '').trim();
                                let lat = parseFloat(latStr);
                                let lng = parseFloat(lngStr);

                                if (!isNaN(lat) && !isNaN(lng)) {
                                    const customIcon = L.divIcon({
                                        className: 'custom-tx-marker',
                                        html: '<div style="background-color: #7B1FA2; width: 14px; height: 14px; border: 2px solid #fff; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.5);"></div>',
                                        iconSize: [18, 18],
                                        iconAnchor: [9, 9]
                                    });

                                    const m = L.marker([lat, lng], { icon: customIcon })
                                        .bindPopup(`<b>âš¡ ${obj['Nombre del proyecto'] || 'TransmisiÃ³n'}</b><br>TensiÃ³n: ${obj['TensiÃ³n ( kV)'] || '?'} kV<br><br><div style="text-align:center;"><a href="tablero-nuevos-proyectos.html" target="_blank" style="background-color: #7B1FA2; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; display: inline-block; font-weight: bold; font-family: sans-serif;">Ver Seguimiento</a></div>`);

                                    clusterGroup.addLayer(m);
                                    transmisionCount++;
                                    hasValidCoords = true;
                                }
                            }

                            if (!hasValidCoords) {
                                transmisionSinCoordsCount++;
                            }
                        });
                    }
                }

                log(`Â¡Terminado! Dibujados ${generacionCount} marcadores de GeneraciÃ³n y ${transmisionCount} de TransmisiÃ³n.`, 'success');
                if (transmisionSinCoordsCount > 0) {
                    log(`Existen ${transmisionSinCoordsCount} proyectos de TransmisiÃ³n que no tienen coordenadas vÃ¡lidas.`, 'warn');
                    addMapAlert('Datos Incompletos', `Identificamos <b>${transmisionSinCoordsCount}</b> proyectos de TransmisiÃ³n sin coordenadas que no se visualizan en el mapa.`, 'alert');
                }

            } catch (e) {
                log('EXCEPCIÃ“N ATRAPADA: ' + e.message, 'error');
                log(e.stack, 'error');
            }
        }

        window.onload = loadData;
    </script>
</body>

</html>